# TypeScript Neverthrow データ取込パイプライン

TypeScript と neverthrow を用いた、運用志向の CSV 取込パイプラインの最小実装です。宣言的なパイプライン構成、厳格なバリデーション、リトライ/レート制御、冪等な永続化、構造化ログを組み合わせています。

```
+----------+      +-------------+      +-------------+      +---------------+      +-----------+
|  CSV IO  | ---> | Validation  | ---> | Policy Gate | ---> | Rate + Retry  | ---> |  Repo +   |
| (csv.ts) |      | (zod)       |      | (policies)  |      | (retry.ts)    |      | Reporting |
+----------+      +-------------+      +-------------+      +---------------+      +-----------+
                                                   \___________________________________________/
                                                              監査ログ: pino (logger.ts)
```

## 特長

- ストリーミング CSV リーダー（`readCsv`）によりメモリを枯渇させずに `RawUser` を逐次生成。
- Zod による正規化と neverthrow でのエラー写像で、入力境界を完全型安全化。
- ポリシーレイヤが重複排除・遅延更新防止・捨てアドレス遮断を担い、失敗時は `PolicyError` を返却。
- `p-limit` と指数バックオフ＋ジッタ付きリトライで永続化を保護し、再実行でも冪等。
- span ID 付きの構造化ログを Pino で出力し、バリデーション失敗やリトライを可観測化。
- レポートは取込件数、勝ち負け内訳、ドメイン分布、失敗サマリを表示。
- Vitest によるバリデーション境界・リトライ制御・冪等性・E2E のテストを同梱。

## セットアップ

```bash
pnpm install
pnpm test
pnpm start -- --source samples/users.csv --idempotency batch-20240501
```

CLI は標準入力を既定ソースとします。`cat users.csv | pnpm start -- --source -` のようにパイプ可能です。

## コンフィグ

`.env`（`.env.example` を参照）に設定を記述し、`src/config.ts` が zod で検証した上で読み込みます。

- `CONCURRENCY`：永続化の最大並列数（例: `4`）。
- `FAIL_FAST`：最初のバリデーション/ポリシー失敗で停止するか。
- `RETRY_*`：指数バックオフの各種パラメータ。
- `IDEMPOTENCY_TTL_MS`：冪等性キャッシュの保持期間。
- `BULK_FAIL_FAST`：バルク upsert 中に失敗したら即座に打ち切るか。
- `LOG_LEVEL`：Pino のログレベル（`info`/`debug`/`silent` など）。

不正設定は `ConfigError` を返し、処理開始前に失敗を明示します。

## 運用メモ

- **可観測性**：パイプライン実行ごとに span ID 付きログを出力。バリデーション失敗件数・ポリシースキップ・リトライ履歴を確認可能。
- **SLO と終了コード**：完全成功は `0`、非致命エラー集約は `2`、致命失敗は `1`。ワークフローや警告トリガーに割り当てやすい構成です。
- **リプレイ/冪等性**：同じ `--idempotency` キーで再投入しても二重書き込みを防止。下流障害からの再実行に安全。
- **スロットリング**：`p-limit` と指数バックオフでバックエンドを保護。SLA に合わせて並列数と遅延を調整してください。

## テスト

`pnpm test` で全テストを実行できます。主な検証内容：

- バリデーション：メール形式・年齢レンジ・日時パースの境界。
- リトライ：初回失敗→成功、最大試行到達時の挙動。
- リポジトリ：同一 idempotency キーでの再投入時にもレコードが増えない。
- 結合テスト：CSV 取込からレポート出力まで。

## 拡張ポイント

- `UserRepository` インタフェースを実 DB/外部サービス実装に差し替え。
- ポリシー判定を設定ファイルやフィーチャーフラグ連携で柔軟化。
- リトライ中に OpenTelemetry/Prometheus メトリクスを発行。
- S3 や HTTP など別ソースから CSV を取得するストリームラッパーを実装。

## 運用チェックリスト

1. ロードテスト中は `LOG_LEVEL=debug` でリトライ動作を追跡。
2. 冪等性 TTL を調整し、キャッシュサイズと再実行ウィンドウのバランスを確保。
3. 捨てアドレスドメインリストを定期更新し、ポリシーの正確性を維持。
